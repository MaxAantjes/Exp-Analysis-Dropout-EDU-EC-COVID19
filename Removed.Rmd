```{r, message = FALSE}
library(openxlsx)
library(stringr)
library(tidyverse)
library(xts)
library(foreign)
library(kableExtra)
```
## Start-of-school-year Matriculations (2009-2019)
### Data Source and Relevance
The data used is summarised matriculation data calculated from the AMIE survey conducted by INEC. This is an annual survey which collects census data on the number of students and teachers at each Ecuadorian primary and secondary institution. Code books and methodology documents are available in this [online repository](https://educacion.gob.ec/amie/)

These data sets are updated every year, so it possible that links stop working. The relevant data sets (tabulados por sostenimiento) can be downloaded from this website: https://educacion.gob.ec/indice-de-tabulados/.

### Download
The following code downloads the data. 
```{r echo = TRUE, results = 'hide', message = FALSE}
## Download Data
links <- list("https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=15555", "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=15556", "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=15557", "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=15558")
dfl <- lapply(links, read.xlsx, sheet = 5, startRow = 12)
addcol <- function(x){
        y <- c("fiscal", "particular", "municipal", "fiscomisional")
        for(i in 1:length(x)){x[[i]]$type <- y[i]}
        return(x)}
dfl1 <- addcol(dfl)
dfl2 <- lapply(dfl1, pivot_longer, cols = "2009-2010.Inicio":"2019-2020.Inicio",
               names_to = "schoolyear", values_to = "no.students")
df <- do.call(rbind, dfl2) %>%
        rename("province" = Provincia)
```

## Start-of-school-year Matriculations Zone 3 (2020)
### Data Source and Relevance
This data summarises the matriculation data in four Ecuadorian provinces at the start of the 2020-2021 school year. The data was taken from a news update by the Ecuadorian Ministry of education. I assume this data to be as accurate as the AMIE tabulated data; this is unlikely to hold true, but it's the best public data available. As the small table was presented as an image, I tabulated it myself in excel and uploaded it into the GitHub repository. Both forms of the data are accessed as follows:  

* Download the excel file [here](https://github.com/MaxAantjes/Exp-Analysis-Dropout-EDU-EC-COVID19/blob/master/dfzone3.csv)  
* Read the news article [here](https://educacion.gob.ec/374-908-estudiantes-inician-un-nuevo-ano-lectivo-en-la-zona-3/)  

### Download
The following code downloads the data. 
```{r}
sdf <- read.csv("dfzone3.csv") %>%
        mutate(schoolyear = "2020-2021.Inicio") %>%
        pivot_longer(cols = "fiscal":"municipal", names_to = "type",
                     values_to = "no.students")
```

## Population projections by year
### Data Source and Relevance
The population projects were calculated by INEC based on the 2010 population census. The methodology and code book is available in the relevant (government repository)[https://www.ecuadorencifras.gob.ec/proyecciones-poblacionales/].

### Download
The following code downloads the data.
```{r}
url <- "https://www.ecuadorencifras.gob.ec/documentos/web-inec/Poblacion_y_Demografia/Proyecciones_Poblacionales/PROYECCION_POR_EDADES_PROVINCIAS_2010-2020_Y_NACIONAL_2010-2020.xlsx"
sheets <- 2:12
years <- 2010:2020
read.mult.xlsx <- function(x, y, z){
  q <- list()
  for(i in 1:length(y)){
        q[[i]] <- read.xlsx(x, sheet = y[i], startRow = 8)
        q[[i]]$year = z[i]}
  q <- do.call(rbind, q)
  return(q)}
tdf <- read.mult.xlsx(url, sheets, years)
```
## Year on Year data of start-of-school-year Matriculations
The following code merges the data from the AMIE summarised data (2009-2019) and the government announcement (2020). It then transforms the data set into a time series data frame, calculates the total amount of students per year and selects the four provinces of interest (Chimborazo, Cotopaxi, Pastaza and Tungurahua). It also clarifies the names of the type of education.  
```{r}
pvint <- c("chimborazo", "cotopaxi", "pastaza", "tungurahua")
df1 <- rbind(df, sdf) %>%
        mutate(schoolyear = as.Date(paste0(
                str_extract(schoolyear, "^[0-9]{4}"), 
                "-09-01"), format = "%Y-%m-%d"))  %>%
        mutate(province = factor(tolower(rep_sp_char(province)))) %>%
        filter(province %in% pvint) %>%
        mutate(type = factor(type, levels = c("fiscal", "particular",
                                              "municipal", "fiscomisional"),
                             labels = c("public", "private", "municipal",
                                        "mixed")))
head(df1)
```
The following code book explains the different variables in detail:
```{r, echo = FALSE}
colnames <- c("province", "type", "schoolyear", "no.students")
explanation <- c("Ecuadorian province name.", "Indicates what finance type the group of education institutions belongs to.", "Approximate Date of School Year Start", "Number of students enrolled at the start of the school year")
values <- c("factor of 4 levels: chimborazo, ...", "factor of 4 levels: public, ...", "Date", "Numeric")
table <- data.frame(cbind(colnames, explanation, values))
kable(table, caption = "Code Book Table 1")
```

## Population projections by year
The following code filters the age groups from 5-19 and selects data from the provinces of interest and restructures the data in an interpretable format.

```{r}
## Clean column names
names(tdf) <- tolower(rep_sp_char(names(tdf)))

## Select data of interest
tdf1 <- tdf %>%
        mutate(age = gsub(" ", "", x1)) %>%
        filter(age %in% c("5-9", "10-14", "15-19")) %>%
        mutate(schoolyear = as.Date(
                paste0(year, "-09-01"), format = "%Y-%m-%d")) %>%
        select(schoolyear, age, "chimborazo" = 'chimbo-razo', cotopaxi, 
               pastaza, "total nacional" = "total.pais",
               "tungurahua" = 'tungu-rahua', 
               ) %>%
        group_by(schoolyear) %>%
        summarise_at(vars(chimborazo:tungurahua), sum) %>%
        pivot_longer(cols = chimborazo:tungurahua, 
                     values_to = "estimated.5-19.yo", 
                     names_to = "province") %>%
        ungroup()
head(tdf1)
```
The following code book explains the different variables in detail:
```{r, echo = FALSE}
colnames <- c("province", "schoolyear", "estimated.5-19.yo")
explanation <- c("Ecuadorian province name.", "Approximate Date of School Year Start. This is only used to merge the data at a later stage. The population estimates themselves pertain to the whole year", "Extimated population of 5-19 year-olds based on 2010 population projections")
values <- c("factor of 4 levels: chimborazo, ...", "Date", "Numeric")
table <- data.frame(cbind(colnames, explanation, values))
kable(table, caption = "Code Book Table 2")
```



# Results
## Drop in Primary and Secondary Education Enrolment viz. Estimated Population
The following code merges the ```df1``` and ```tdf1``` data frames, as well as prepares them for data visualisation.
```{r}
df2 <- df1 %>%
        group_by(province, schoolyear) %>%
        summarise(no.students = sum(no.students)) %>%
        left_join(tdf1, by = c("province", "schoolyear")) %>%
        pivot_longer(cols = 3:4, values_to = "population.size",
                     "population.type") %>%
            mutate(population.type = ifelse(
            population.type == "no.students", 
            "Matriculated Students", "5-19 Year-Olds (Estimate)")) 
```
The following code graphs the data.
```{r, warning = FALSE}
p <- ggplot(dat = df2, aes(y = population.size/1000, x = schoolyear,
                              col = population.type))
p1 <- p + facet_grid(~province)
p2 <- p1 + geom_point() + geom_line() + geom_vline(aes(xintercept = as.Date("13-03-2020", format = "%d-%m-%Y"), col = "Start School Lockdown"))
p3 <- p2 + theme_bw()
p4 <- p3 + labs(title = "Number of secondary and primary students matriculated\nat the start of school year vs. estimated population\naged 5-19 years old",
                x = "Year", y = "Population Size (in thousands)") +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p5 <- p4 + scale_colour_discrete(name = "")
p5
```
## Transition from Private to Public Schools

The following code filters the data for year 2019 and 2020 for public and private institutions. It then calculates the change in student enrolment.
```{r}
df3 <- df1 %>%
        mutate(schoolyear = str_extract(schoolyear, "^[0-9]{4}")) %>%
        filter(schoolyear %in% c(2019, 2020)) %>%
        mutate(schoolyear = ifelse(schoolyear == 2019, "y2019", "y2020")) %>%
        pivot_wider(values_from = no.students, names_from = schoolyear) %>%
        mutate(change = (y2020 - y2019)) %>%
        filter(type %in% c("public", "private"))
```

The following code graphs the data. 
```{r}
p <- ggplot(data = df3, aes(y = change, 
                            x = province, fill = type))
p1 <- p + geom_bar(stat = "identity", position = "dodge")
p2 <- p1 + theme_bw() +
        theme(axis.text.x=element_text(angle = 90, vjust = 0.5))
p3 <- p2 + labs(y = "Change in the number of Students (Absolute)",
                x = "Province",
                title = "Figure 1: The Change in Primary and Secondary\nEducation Enrolment between 2019 and 2020 in Zone 3",
                caption = "Source: Data from INEC (AMIE) and MINEDUC\nData Summary by author (Max Aantjes)")
p4 <- p3 + scale_fill_discrete(name = "School Type", labels = c("Public",
                                          "Private"))
p4
```