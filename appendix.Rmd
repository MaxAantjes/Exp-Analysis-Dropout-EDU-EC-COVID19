---
title: "Appendix"
author: "Max Aantjes"
date: "15/09/2020"
output:
  github_document:
    toc: true
    toc_depth: 2
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction
The following sections contain all computations for the creation of the exploratory data results summarised in the brief paper. Computations are accompanied by references and justifications to clarify any choices made. 

# R Packages
The following R packages are used in the subsequent code sections. 
```{r, message = FALSE}
library(openxlsx)
library(stringr)
library(tidyverse)
library(kableExtra)
library(RColorBrewer)
```
The following code loads a useful function to account for special characters.
```{r}
rep_sp_char <- function(x){
        sp_char <- c("á", "é", "í", "ó", "ñ")
        rep <- c("a", "e", "i", "o", "n")
        for(i in 1:length(rep)){
                x <- gsub(sp_char[i], rep[i], x)}
        return(x)}
```

# Context of Data Sets
## Data Set 1
The data used is the AMIE survey conducted by INEC (non-summarised). This annual survey collects census data on the number of students and teachers at each Ecuadorian primary and secondary institution. Code books and methodology documents are available in this [online repository](https://educacion.gob.ec/amie/)

## Data Set 2
The data used is summarised matriculation data calculated from the AMIE survey conducted by INEC. This is an annual survey which collects census data on the number of students and teachers at each Ecuadorian primary and secondary institution. Code books and methodology documents are available in this [online repository](https://educacion.gob.ec/amie/)

These data sets are updated every year, so it possible that links stop working. The relevant data sets (tabulados por sostenimiento) can be downloaded from this website: https://educacion.gob.ec/indice-de-tabulados/.

# Download of Data Sets
## Data Set 1
The following code downloads the data.
```{r}
y2009s <- "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=10555"
y2010s <- "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=10557"
y2011s <- "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=10559"
y2012s <- "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=10561"
y2013s <- "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=12176"
y2014s <- "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=10567"
y2015s <- "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=10569"
y2016s <- "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=10573"
y2017s <- "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=12645"
y2018s <- "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=15711"
y2019s <- "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=15713"

l1 <- list(y2009s, y2010s, y2011s, y2012s, y2013s, y2014s, y2015s, y2016s, y2017s)

dfl1 <- lapply(l1, read.xlsx, sheet = 1, startRow = 11)
dfl2 <- read.xlsx(y2018s, sheet = 2, startRow = 13)
dfl3 <- read.xlsx(y2019s,  sheet = "Registros Administrativos", startRow = 13)

dfl1_1 <- do.call(rbind, dfl1)

select_cols <- function(x){
        names(x) <- tolower(rep_sp_char(names(x)))
        z <- x %>%
                select(periodo, total.estudiantes, total.docentes, provincia,
                       nombre.institucion, zona.inec, sostenimiento, canton,
                       nivel.educacion)
        return(z)}

dfl1_2 <- select_cols(dfl1_1)
dfl2_1 <- select_cols(dfl2)

names(dfl3) <- tolower(rep_sp_char(names(dfl3)))
names(dfl3)[2] <- "duplicate"
dfl3_1 <- dfl3 %>%
                select(-duplicate) %>%
                select(periodo, "total.estudiantes" = 34, total.docentes, provincia,
                       nombre.institucion, zona.inec, sostenimiento, canton,
                       nivel.educacion)

df <- rbind(dfl1_2, dfl2_1, dfl3_1)
```

# Data Cleaning
## Data Set 1
The following code selects the columns of interests, translates them and turns them into factors. It should be noted here that column 35 (which is selected) **only** counts students enrolled in primary and secondary education. It also transforms the year variable into a date variable.

```{r}
not.of.interest <- c("Alfabetización P.P", "Artesanal P.P", "Formación Artística", "No escolarizado", "No registrado")
df1 <- df %>%
        select("year" = periodo, "name" = nombre.institucion, "area" = zona.inec, 
               "province" = provincia, "canton" = canton, "type" = sostenimiento,
               "tot.teachers" = total.docentes, "tot.students" = total.estudiantes,
               nivel.educacion) %>%
        mutate(type = factor(tolower(gsub(" ", "", type)), 
                             levels = c("municipal", "fiscomisional", "particular", 
                                        "particularlaico", "particularreligioso", "fiscal"),
                             labels = c("municipal", "mixed", "private", "private", 
                                        "private", "public"),
                             ordered = TRUE)) %>%
        mutate(area = factor(str_remove(area, "INEC"), 
               levels = c("Rural", "Urbana"), labels = c("rural", "urban"))) %>%
        mutate(canton = factor(tolower(canton))) %>%
        mutate(province = factor(tolower(province))) %>%
        mutate(year = str_extract(year, "^[0-9]{4}")) %>%
        mutate(year = as.Date(paste0(year, "-05-01"))) %>%
        filter(!nivel.educacion %in% not.of.interest) %>%
        select(-nivel.educacion)
```
The following code book explains the different variables in detail:
```{r, echo = FALSE}
colnames <- c("name", "area", "type", "canton", "tot.teachers", "estimated.5-19.yo", "education.level")
explanation <- c("Institution name", "Indicates whether the institution is in a rural or urban area.", "Indicates how the institution is financed", "Ecuadorian canton name.", "Total number of teachers at the institution", "Total number of students at the institution", "The levels of education provided by the institution")
values <- c("ID as characters", "factor of 2 levels: rural, urban", "factor of 4 levels: public, ...", "factor of 222 levels: LOJA, ...", "numeric", "numeric", "factor of 18 levels, numbers assigned alphabetically")
table <- data.frame(cbind(colnames, explanation, values))
kable(table, caption = "Code Book data frame DF1")
```
Checkign missing data
```{r}
summary(factor(df1$year[is.na(df1$type)]))
df2 <- df1
```

## Data Set 2

## Manipulation of the Data
The following code creates a data frame which calculates the median student-teacher ratio for each canton (rural and urban area). It then creates a data frame which calculates the percentage of students which are enrolled in private schools per canton (rural and urban area). These two variables will be used for OLS regressions. Finally, the two data frames are merged. 

```{r}
missing_to_zero <- function(var){return(ifelse(is.na(var), 0, var))}

total <- df2 %>%
            filter(tot.students > 10 & tot.teachers > 0) %>%
            group_by(year, type) %>%
            summarise_at(.vars = c("tot.students", "tot.teachers"), .funs = sum) %>%
            mutate(name = "total") %>%
            mutate(area = "total") %>%
            mutate(province = "total") %>%
            mutate(canton = "total") 

df3 <- rbind(df2, total)

st_calc <- function(x) {
        z <- x %>%
            filter(tot.students > 10 & tot.teachers > 0) %>%
            mutate(stratio = tot.students/tot.teachers) %>%
            summarise(med.stratio = median(stratio), 
                         sum.students = sum(tot.students),
                         sum.teachers = sum(tot.teachers))
        return(z)}

dfprov <- st_calc(df3 %>% group_by(year, province, type)) 
dfcan <- st_calc(df3 %>% group_by(year, canton, type, area))

prop_calc <- function(x, y, q){
        z <- x %>%
            summarise(n = sum(tot.students)) %>%
            pivot_wider(names_from = type, values_from = n) %>%
            mutate(public = missing_to_zero(public)) %>%
            mutate(mixed = missing_to_zero(mixed)) %>%
            mutate(municipal = missing_to_zero(municipal)) %>%
            mutate(private = missing_to_zero(private)) %>%
            mutate(total = public + mixed + municipal + private) %>%
            mutate(public = (public/total)*100) %>%
            mutate(mixed = (mixed/total)*100) %>%
            mutate(municipal = (municipal/total)*100) %>%
            mutate(private = (private/total)*100) %>%
            pivot_longer(cols = c(public, mixed, municipal, private), 
                         values_to = "prop.students", names_to = "type") %>%
            select(-total) %>%
            left_join(y, by = q) %>%
            mutate(med.stratio = missing_to_zero(med.stratio)) %>%
            mutate(sum.students = missing_to_zero(sum.students)) %>%
            mutate(sum.teachers = missing_to_zero(sum.teachers)) %>%
            ungroup()
        return(z)}

dfprov1 <- prop_calc(x = df3 %>% group_by(year, province, type), 
                     y = dfprov, q = c("year", "province", "type"))
dfcan1 <- prop_calc(x = df3 %>% group_by(year, canton, type, area), 
                     y = dfcan, q = c("year", "canton", "type", "area"))
```
The following code book explains the different variables in detail for the ```dfprov1``` data frame:
```{r, echo = FALSE}
colnames <- c("year", "province", "prop.students", "med.stratio", "sum.students", "sum.teachers")
explanation <- c("Indicates the school year (as data pertains to the start of the school year, the date is set to the First of May (roughly the start of the Ecuadorian schoolyear at the coast).", "Indicates the Ecuadorian province in which the institutions are located.", "Proportion of students enrolled per type of education.", "Median Student/Teacher ratio, ratios calculated at school level by dividing the number of teachers by the number of students", "Aggregate of all students at all schools (initial to bachelor level)", "Aggregate of all teachers")
values <- c("Date", "Factor of 26 levels: azuay, ...", "Numeric", "Numeric", "Numeric", "Numeric")
table <- data.frame(cbind(colnames, explanation, values))
kable(table, caption = "Code Book data frame dfprov1")
```
The following code book explains the different variables in detail for the ```dfcan1``` data frame:
```{r, echo = FALSE}
colnames <- c("year", "canton", "area", "prop.students", "med.stratio", "sum.students", "sum.teachers")
explanation <- c("Indicates the school year (as data pertains to the start of the school year, the date is set to the First of May (roughly the start of the Ecuadorian schoolyear at the coast).", "Indicates the Ecuadorian canton in which the institutions are located.", "The area of the canton in which the institutions are located", "Proportion of students enrolled per type of education.", "Median Student/Teacher ratio, ratios calculated at school level by dividing the number of teachers by the number of students", "Aggregate of all students at all schools (initial to bachelor level)", "Aggregate of all teachers")
values <- c("Date", "Factor of 26 levels: azuay, ...", "Factor of 2 levels: rural, urban", "Numeric", "Numeric", "Numeric", "Numeric")
table <- data.frame(cbind(colnames, explanation, values))
kable(table, caption = "Code Book data frame dfcan1")
```

# Results
## What happened to the ST ratio with past fluctuations in enrollment?
The following code summarises the data from the ```dfprov1``` data frame. Figure 2 demonstrates that the student teacher ratios rose from 2010 to 2014 in public schools, after which they dropped again. Figure 3 demonstrates that this rise in ST ratio mostly arose because of a rise in public students, as well as a small decrease in private school students. The main reason for this rise is that the number of teachers enrolled in public education has turned out to be inelastic to the increase in public student enrolment.
```{r}
p <- ggplot(dat = dfprov1 %>% filter(province == "total"), aes(x = year, y = med.stratio, col = type))
p1 <- p + geom_point() + geom_line()
p2 <- p1 + theme_bw() + labs(title = "Figure 1: Median Teacher Student Ratio", y = "")
p2

p <- ggplot(dat = dfprov1 %>% filter(province == "total"), aes(x = year, y = sum.students/1000000, fill = type))
p1 <- p + geom_area() + scale_fill_brewer(palette="Pastel1") 
p2 <- p1 + theme_bw() + labs(title = "Figure 2: Total Students Enrolled (in millions)", y = "")
p2

p <- ggplot(dat = dfprov1 %>% filter(province == "total"), aes(x = year, y = sum.teachers/1000, fill = type))
p1 <- p + geom_area() + scale_fill_brewer(palette="Pastel1") 
p2 <- p1 + theme_bw() + labs(title = "Figure 3: Total Teachers Enrolled (in thousands)", y = "")
p2
```

## What is the relationship between enrollment proportions and ST ratios in public schools?
### Hypotheses
Based on the exploration of the data, it seems plausible that the number of teachers in public education is inelastic to the number of students. Accordingly, we expect that an increase in private education enrollment will decrease the ST ratio in public schools (and vice versa). Accordingly, the analysis attempts to test the following hypotheses:

*H0_1: The ST ratio in public schools for different proportions of enrolment in public education are equal (as long as > 0% of students are enrolled in public schools).  
* H0_2: The ST ratio in public schools for different proportions of enrolment in private education are equal (as long as > 0% of students are enrolled in public schools).

These hypotheses will be tested through an OLS regression. 

### Specification of Variable Quantifiers
The following code prepares the data frame for further analysis (with a wider data frame the proportions of different types of education can be regressed against the ST ratio of different types of education). 

```{r}
dfcan2019 <- dfcan1 %>%
          filter(year == as.Date("2019-05-01")) %>%
          pivot_wider(names_from = type,
                      values_from = c(prop.students:sum.teachers)) %>%
          filter(canton != "total")
```

For an OLS regression, we are looking for independent and dependent variables which are normally distributed. The following code tests the distribution of the two variables (proportion and ST ratio) for urban and rural areas. It demonstrates that student-teacher ratios are normally distributed. To the contrary the proportion of private students is not. Nevertheless, by taking the log, we can generate a distribution for both areas which approximates a normal. Any 0% proportions were removed here (as its log generates a negative Infinite number). This is illustrative for other proportions (the graphs are left out to save space). 

For this reason two decisions are made:  
1. the log version will be used for regression;  
2. 0% proportion will be removed for regression. This limits the conclusions of the study: the relationship is only tested in places where the 

```{r}
par(mfrow = c(2,3))
hist(dfcan2019$prop.students_private[dfcan2019$area == "rural"], 
     main = "Prop ST Priv. Rur.", xlab = "", breaks = 40)
hist(dfcan2019$prop.students_private[dfcan2019$area == "urban"], 
     main = "Prop ST Priv. Urb.", xlab = "", breaks = 40)
hist(log(dfcan2019$prop.students_private[dfcan2019$area == "rural" & 
                                           dfcan2019$prop.students_private > 0]), 
     main = "Log Prop ST Priv. Rur.", xlab = "", breaks = 20)
hist(log(dfcan2019$prop.students_private[dfcan2019$area == "urban" & 
                                           dfcan2019$prop.students_private > 0]), 
     main = "Log Prop ST Priv. Urb.", xlab = "", breaks = 20)
hist(dfcan2019$med.stratio_public[dfcan2019$area == "rural"], 
     main = "Pub. ST Ratio Rur.", xlab = "", breaks = 20)
hist(dfcan2019$med.stratio_public[dfcan2019$area == "urban"], 
     main = "Pub. ST Ratio Urb.", xlab = "", breaks = 20)
```

### OLS Regression
The following code creates a graph of the relationship of the two variables, as well as its OLS regression with the student-teacher ratio in public schools as the dependent variable and the log of the proportion of students attending a particular type of institution (mixed, private and public) as the independent variable. For the independent variable any proportions of 0% are removed for reasons specified above.

```{r, echo = FALSE}
p <- ggplot(dat = dfcan2019 %>% filter(prop.students_public > 0), 
            aes(y = med.stratio_public, x = log(prop.students_public))) + theme_bw() 
p1 <- p + geom_point(alpha = 1/4) + facet_grid(~area)
p2 <- p1 + geom_smooth(method = "lm", formula = y~x) 
p3 <- p2 + theme(axis.text.x = element_text(angle = 90)) + labs(
  x = "Proportion of students enrolled\nin public education (log)", 
  y = "Median Student-Teacher\nratio in public schools",
  title = "Figure 4: Weak Positive Relationship between Public Education\nAttendance and ST Ratio in Public Schools",
  subtitle = "Cantons with public education enrolment < 0% removed.",
  caption = "AMIE Data collected by INEC (2019)\nData Summary by Max Aantjes")
p3

p <- ggplot(dat = dfcan2019 %>% filter(prop.students_private > 0), aes(y = med.stratio_public, x = log(prop.students_private))) + theme_bw() 
p1 <- p + geom_point(alpha = 1/4) + facet_grid(~area)
p2 <- p1 + geom_smooth(method = "lm", formula = y~x) 
p3 <- p2 + theme(axis.text.x = element_text(angle = 90)) + labs(
  x = "Proportion of students enrolled\nin private education (log)", 
  y = "Median Student-Teacher\nratio in public schools",
  title = "Figure 5: Strong Positive Relationship between Private Education\nAttendance and ST Ratio in Public Schools",
  subtitle = "Cantons with pprivate education enrolment < 0% removed.", 
  caption = "AMIE Data collected by INEC (2019)\nData Summary by Max Aantjes")
p3

p <- ggplot(dat = dfcan2019 %>% filter(prop.students_mixed > 0), aes(y = med.stratio_public, x = log(prop.students_mixed))) + theme_bw() 
p1 <- p + geom_point(alpha = 1/4) + facet_grid(~area)
p2 <- p1 + geom_smooth(method = "lm", formula = y~x) 
p3 <- p2 + theme(axis.text.x = element_text(angle = 90)) + labs(
  x = "Proportion of students enrolled\nin mixed education (log)", 
  y = "Median Student-Teacher\nratio in public schools",
  title = "Figure 6: Negative Relationship between Mixed Education\nAttendance and ST Ratio in Public Schools",
  subtitle = "Cantons with mixed education enrolment < 0% removed.", 
  caption = "AMIE Data collected by INEC (2019)\nData Summary by Max Aantjes")
p3

p <- ggplot(dat = dfcan2019 %>% filter(prop.students_private > 0 | prop.students_mixed > 0), aes(y = med.stratio_public, x = log(prop.students_private + prop.students_mixed))) + theme_bw()
p1 <- p + geom_point(alpha = 1/4) + facet_grid(~area)
p2 <- p1 + geom_smooth(method = "lm", formula = y~x) 
p3 <- p2 + theme(axis.text.x = element_text(angle = 90)) + labs(
  x = "Proportion of students enrolled\nin private and mixed education (log)", 
  y = "Median Student-Teacher\nratio in public schools",
  title = "Figure 7: Weak Negative Relationship between Private and\nMixed Education Attendance and ST Ratio in Public Schools", 
  subtitle = "Cantons with mixed AND private education enrolment < 0% removed.",
  caption = "AMIE Data collected by INEC (2019)\nData Summary by Max Aantjes")
p3
```

As expected, public education enrolment has a positive effect on ST ratio in public schools. However, the relationship is rather weak and shows much variation in cantons with close to 100% school enrolment. Therefore, we cannot plausibly reject the first null-hypothesis.

We will thus focus on the other results. In cantons with private school enrolment, there is a strong relationship between private education enrolment and the ST ratio in public schools. Surprisingly, however, mixed school enrolment (which is semi-private) has a negative relationship on ST ratio in public schools. How is this possible? We will first explore the OLS regression a bit further. The following code calculates relevant statistics for the relationship between private school enrolment and the ST ratio in public schools. 

```{r}
dfcan2019urb <- dfcan2019[dfcan2019$prop.students_private > 0,] %>% filter(area == "urban")
r <- lm(formula = med.stratio_public ~ log(prop.students_private), data = dfcan2019urb)
summary(r)$r.squared
summary(r)$coefficients
plot(r)
```

This means that if an area A's proportion of private students is 100% higher than that of area B (e.g. 5% and 10%), then we expect the ST ratio to be 1 unit higher in area A, or in other words, for there to be 1 more student for every teacher in area B. The R squared value indicates that more than 27% of the variation of ST ratios of cantons **with private institutions can be explained by the OLS model**. The plots indicate that the data is roughly homoscedastic. This suggests OLS regression is appropriate for the data. 

```{r}
dfcan2019urb <- dfcan2019_2 %>% filter(area == "urban")
r <- lm(formula = med.stratio_public ~ log(prop.students_private + prop.students_mixed), data = dfcan2019urb)
summary(r)$r.squared
summary(r)$coefficients
plot(r)
```

In an isolated scenario these results would be sufficient to reject the second null hypothesis. However, the results in terms of mixed institutions indicate something different might be at play here. One possibility is that ST ratios are simply higher in populated areas (large cities) - which is consistent with the assumption that teacher hiring is inelastic - and that mixed institutions are primarily located in low population areas, whilst private institutions are primarily located in high population areas - larger inequality in incomes or a lesser influence by the church (which runs most mixed institutions) in urban areas might explain this divergence. 
The following code tests this alternative explanation by regressing the ST Ratio in public schools against the total number of students. It then classifies cantons according to the amount of students enrolled in mixed and private education. It demonstrates that ST ratios are higher in areas with a higher population and that this is where private institutions tend to be located. It also demonstrates that ST ratios are lower in areas with a lower population and that this is where mixed institutions tend to be located. 

Accordingly, the positive relationship between private education enrolment and ST ratios is thus plausibly explained by the number of students in areas with high private education enrolment. The second null-hypothesis can thus not be rejected due to this confounding variable. It does highlight an important fact about where educational institutions are located, however, and which types of schools should be of particular concern to the government: private rather than mixed schools. 

```{r}
test <- dfcan2019 %>%
        mutate(classification = ifelse(prop.students_mixed >= 5 & prop.students_private <= 5, 
                                       "PMS > 4.9% and PPS < 5%", "PH")) %>%
        mutate(classification = ifelse(prop.students_mixed <= 5 & prop.students_private >= 5, 
                                       "PMS < 5% and PPS > 4.9%", classification)) %>%
        filter(classification != "PH")

p <- ggplot(data = test, aes(x = log(sum.students_public), 
                                  y = med.stratio_public, col = classification))
p1 <- p + geom_point(alpha = 1/4) + theme_bw()
p2 <- p1 + labs(x = "Total Students in Canton (log)", y = "Median Student-Teacher\nRatio in Public Schools",
                title = "Figure 8: ST Ratio in Public Schools increases\nwith Total Number of Students per Canton",
                subtitle = "PMS = Proportion of Students in Mixed Education\nPPS = Proportion of Students in Private Education")
p2
```