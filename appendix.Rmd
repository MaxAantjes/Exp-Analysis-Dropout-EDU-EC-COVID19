---
title: "Appendix"
author: "Max Aantjes"
date: "15/09/2020"
output:
  github_document:
    toc: true
    toc_depth: 2
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction
The following sections contain all computations for the creation of the exploratory data results summarised in the brief paper. Computations are accompanied by references and justifications to clarify any choices made. 

# R Packages
The following R packages are used in the subsequent code sections. 
```{r, message = FALSE}
library(openxlsx)
library(stringr)
library(tidyverse)
library(kableExtra)
library(xts)
```
The following code loads a useful function to account for special characters.
```{r}
rep_sp_char <- function(x){
        sp_char <- c("á", "é", "í", "ó", "ñ")
        rep <- c("a", "e", "i", "o", "n")
        for(i in 1:length(rep)){
                x <- gsub(sp_char[i], rep[i], x)}
        return(x)}
```

# Context of Data Sets
## Data Set 1
The data used is the AMIE survey conducted by INEC (non-summarised). This annual survey collects census data on the number of students and teachers at each Ecuadorian primary and secondary institution. Code books and methodology documents are available in this [online repository](https://educacion.gob.ec/amie/)

## Data Set 2
The data used is summarised matriculation data calculated from the AMIE survey conducted by INEC. This is an annual survey which collects census data on the number of students and teachers at each Ecuadorian primary and secondary institution. Code books and methodology documents are available in this [online repository](https://educacion.gob.ec/amie/)

These data sets are updated every year, so it possible that links stop working. The relevant data sets (tabulados por sostenimiento) can be downloaded from this website: https://educacion.gob.ec/indice-de-tabulados/.

# Download of Data Sets
## Data Set 1
The following code downloads the data.
```{r}
y2009s <- "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=10555"
y2010s <- "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=10557"
y2011s <- "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=10559"
y2012s <- "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=10561"
y2013s <- "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=12176"
y2014s <- "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=10567"
y2015s <- "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=10569"
y2016s <- "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=10573"
y2017s <- "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=12645"
y2018s <- "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=15711"
y2019s <- "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=15713"

l1 <- list(y2009s, y2010s, y2011s, y2012s, y2013s, y2014s, y2015s, y2016s, y2017s)

dfl1 <- lapply(l1, read.xlsx, sheet = 1, startRow = 11)
dfl2 <- read.xlsx(y2018s, sheet = 2, startRow = 13)
dfl3 <- read.xlsx(y2019s,  sheet = "Registros Administrativos", startRow = 13)

dfl1_1 <- do.call(rbind, dfl1)

select_cols <- function(x){
        names(x) <- tolower(rep_sp_char(names(x)))
        z <- x %>%
                select(periodo, total.estudiantes, total.docentes, provincia,
                       nombre.institucion, zona.inec, sostenimiento, canton)
        return(z)}

dfl1_2 <- select_cols(dfl1_1)
dfl2_1 <- select_cols(dfl2)

names(dfl3) <- tolower(rep_sp_char(names(dfl3)))
names(dfl3)[2] <- "duplicate"
dfl3_1 <- dfl3 %>%
                select(-duplicate) %>%
                select(periodo, "total.estudiantes" = 34, total.docentes, provincia,
                       nombre.institucion, zona.inec, sostenimiento, canton)

df <- rbind(dfl1_2, dfl2_1, dfl3_1)
```

# Data Cleaning
## Data Set 1
The following code selects the columns of interests, translates them and turns them into factors. It should be noted here that column 35 (which is selected) **only** counts students enrolled in primary and secondary education. It also transforms the year variable into a date variable.

```{r}
df1 <- df %>%
        select("year" = periodo, "name" = nombre.institucion, "area" = zona.inec, 
               "province" = provincia, "canton" = canton, "type" = sostenimiento,
               "tot.teachers" = total.docentes, "tot.students" = total.estudiantes) %>%
        mutate(type = factor(tolower(type), 
                             levels = c("fiscal", "particular", "particular laico", 
                                        "paritcular religioso", "municipal", "fiscomisional"),
                             labels = c("public", "private", "private", "mixed", "municipal",
                                        "mixed"))) %>%
        mutate(area = factor(str_remove(area, "INEC"), 
               levels = c("Rural", "Urbana"), labels = c("rural", "urban"))) %>%
        mutate(canton = factor(tolower(canton))) %>%
        mutate(province = factor(tolower(province))) %>%
        mutate(year = str_extract(year, "^[0-9]{4}")) %>%
        mutate(year = as.Date(paste0(year, "-05-01")))
```
The following code book explains the different variables in detail:
```{r, echo = FALSE}
colnames <- c("name", "area", "type", "canton", "tot.teachers", "estimated.5-19.yo", "education.level")
explanation <- c("Institution name", "Indicates whether the institution is in a rural or urban area.", "Indicates how the institution is financed", "Ecuadorian canton name.", "Total number of teachers at the institution", "Total number of students at the institution", "The levels of education provided by the institution")
values <- c("ID as characters", "factor of 2 levels: rural, urban", "factor of 4 levels: public, ...", "factor of 222 levels: LOJA, ...", "numeric", "numeric", "factor of 18 levels, numbers assigned alphabetically")
table <- data.frame(cbind(colnames, explanation, values))
kable(table, caption = "Code Book data frame DF1")
```
Checkign missing data
```{r}
summary(factor(df1$year[is.na(df1$type)]))
df2 <- df1 %>%
        na.omit()
```

## Data Set 2

## Manipulation of the Data
The following code creates a data frame which calculates the median student-teacher ratio for each canton (rural and urban area). It then creates a data frame which calculates the percentage of students which are enrolled in private schools per canton (rural and urban area). Finally, the two data frames are merged. 

```{r}
missing_to_zero <- function(var){return(ifelse(is.na(var), 0, var))}

st_calc <- function(x) {
        z <- x %>%
            filter(tot.students > 10 & tot.teachers > 0) %>%
            mutate(stratio = tot.students/tot.teachers) %>%
            summarise(stratio = median(stratio)) %>%
            mutate(type = paste0(type, "_stratio")) %>%
            pivot_wider(names_from = type, values_from = stratio)
        return(z)}

dfprov <- st_calc(df2 %>% group_by(year, province, type))
dfcan <- st_calc(df2 %>% group_by(year, canton, type))

prop_calc <- function(x, y, q){
        z <- x %>%
            summarise(n = sum(tot.students)) %>%
            pivot_wider(names_from = type, values_from = n) %>%
            mutate(public = missing_to_zero(public)) %>%
            mutate(mixed = missing_to_zero(mixed)) %>%
            mutate(municipal = missing_to_zero(municipal)) %>%
            mutate(private = missing_to_zero(private)) %>%
            mutate(prop1 = ((private)/sum(public, mixed, private, municipal))*100) %>%
            mutate(prop2 = ((private + mixed)/sum(public, mixed, private, municipal))*100) %>%
            select(-c(public, mixed, municipal, private)) %>%
            left_join(y, by = q) %>%
            mutate(public_stratio = missing_to_zero(public_stratio)) %>%
            mutate(private_stratio = missing_to_zero(private_stratio)) %>%
            mutate(mixed_stratio = missing_to_zero(mixed_stratio)) %>%
            mutate(municipal_stratio = missing_to_zero(municipal_stratio)) %>%
            ungroup()
        return(z)}

dfprov1 <- prop_calc(x = df2 %>% group_by(year, province, type), 
                     y = dfprov, q = c("year", "province"))
dfcan1 <- prop_calc(x = df2 %>% group_by(year, canton, type), 
                     y = dfcan, q = c("year", "canton"))

dfprov2 <- xts(x = dfprov1[, 2:length(dfprov1)], order.by = dfprov1$year) ## Change this. 
```
The following code book explains the different variables in detail:
```{r, echo = FALSE}
colnames <- c("area", "canton", "stratio", "prop1", "prop2")
explanation <- c("Indicates whether the institutions were in a rural or urban area.", "Indicates the Ecuadorian canton in which the institutions are located.", "Median Student/Teacher ratio, ratios calculated at school level by dividing the number of teachers by the number of students", "Proportion of enrolled students enrolled in private education.", "Proportion of enrolled students enrolled in private and mixed education.")
values <- c("factor of 2 levels: rural, urban", "factor of 222 levels: LOJA, ...", "Numeric", "Numeric", "Numeric")
table <- data.frame(cbind(colnames, explanation, values))
kable(table, caption = "Code Book data frame SDF1")
```

# Results
The following code tests the distribution of the two variables for urban and rural areas. It demonstrates that student-teacher ratios are normally distributed. To the contrary the proportion of private students is not. Nevertheless, by taking the log, we can generate a distribution for both areas which approximates a normal. The log version will therefore be used for the purpose of regression analysis. 

```{r}
par(mfrow = c(3,4))
hist(sdf1$prop1[sdf1$area == "rural"], 
     main = "Prop 1. Rural", xlab = "", breaks = 20)
hist(sdf1$prop1[sdf1$area == "urban"], 
     main = "Prop 1. Urban", xlab = "", breaks = 20)
hist(log(sdf1$prop1[sdf1$area == "rural" & sdf1$prop1 > 0]), 
     main = "Log Prop 1. Rural\n(0's removed)", xlab = "", breaks = 20)
hist(log(sdf1$prop1[sdf1$area == "urban" & sdf1$prop1 > 0]), 
     main = "Log Prop 1. Urban\n(0's removed)", xlab = "", breaks = 20)
hist(sdf1$prop2[sdf1$area == "rural"], 
     main = "Prop 2. Rural", xlab = "", breaks = 20)
hist(sdf1$prop2[sdf1$area == "urban"], 
     main = "Prop 2. Urban", xlab = "", breaks = 20)
hist(log(sdf1$prop2[sdf1$area == "rural" & sdf1$prop2 > 0]), 
     main = "Log Prop 2. Rural\n(0's removed)", xlab = "", breaks = 20)
hist(log(sdf1$prop2[sdf1$area == "urban" & sdf1$prop2 > 0]), 
     main = "Log Prop 2. Urban\n(0's removed)", xlab = "", breaks = 20)
hist(sdf1$stratio[sdf1$area == "rural"], 
     main = "ST Ratio Rural", xlab = "", breaks = 20)
hist(sdf1$stratio[sdf1$area == "urban"],
     main = "ST Ratio Urban", xlab = "", breaks = 20)
```

```{r}
sdfprop1<- sdf1[sdf1$prop1 != 0,]
sdfprop2 <- sdf1[sdf1$prop2 != 0,]
data.frame(summary(sdf1$area), set = "total")
data.frame(summary(sdfprop1$area), set = "prop1>0")
data.frame(summary(sdfprop2$area), set = "prop2>0")
```


The following code creates a graph of the relationship of the two variables, as well as its OLS regression with the student-teacher ratio in public schools as the dependent variable and the log of the proportion of private students as the independent variable. 

```{r, warning = FALSE}
p <- ggplot(dat = sdf2, aes(y = stratio, x = log(prop1))) + theme_bw() 
p1 <- p + geom_point(alpha = 1/4) + facet_grid(~area)
p2 <- p1 + geom_smooth(method = "lm", formula = y~x) 
p3 <- p2 + theme(axis.text.x = element_text(angle = 90)) + labs(
  x = "Proportion of students enrolled\nin private education (log)", 
  y = "Median Student-Teacher\nratio in public schools",
  title = "Private Education Attendance and ST Ratio\nin Ecuadorian cantons",
  subtitle = "Urban and rural areas in each canton were considered separately.\nAdditionally, canton areas with no private schools were removed\nfrom the data set. This means only 42 (of 139) rural canton areas\nand 127 (of 218) canton areas were considered.", 
  caption = "AMIE Data collected by INEC (2019)\nData Summary by Max Aantjes")
p3
```


```{r}
sdfprop1urb <- sdfprop1 %>% filter(area == "urban")
r <- lm(formula = stratio ~ log(prop1), data = sdfprop1urb)
summary(r)$r.squared
summary(r)$coefficients
```

```{r}
sdfprop1rur <- sdfprop1 %>% filter(area == "rural")
r <- lm(formula = stratio ~ log(prop1), data = sdfprop1rur)
summary(r)$r.squared
summary(r)$coefficients
```

```{r, warning = FALSE}
p <- ggplot(dat = sdf3, aes(y = stratio, x = log(prop2))) + theme_bw() 
p1 <- p + geom_point(alpha = 1/4) + facet_grid(~area)
p2 <- p1 + geom_smooth(method = "lm", formula = y~x) 
p3 <- p2 + theme(axis.text.x = element_text(angle = 90)) + labs(
  x = "Proportion of students enrolled\nin private education (log)", 
  y = "Median Student-Teacher\nratio in public schools",
  title = "Private and Mixed Education Enrolment and ST Ratio\nin Ecuadorian Cantons",
  subtitle = "Urban and rural areas in each canton were considered separately.\nAdditionally, canton areas with no private schools were removed\nfrom the data set. This means only 42 (of 139) rural canton areas\nand 127 (of 218) canton areas were considered.", 
  caption = "AMIE Data collected by INEC (2019)\nData Summary by Max Aantjes")
p3
```

```{r}
sdfprop2urb <- sdfprop2 %>% filter(area == "urban")
r <- lm(formula = stratio ~ log(prop2), data = sdfprop2urb)
summary(r)$r.squared
summary(r)$coefficients
```

```{r}
sdfprop2rur <- sdfprop2 %>% filter(area == "rural")
r <- lm(formula = stratio ~ log(prop2), data = sdfprop2rur)
summary(r)$r.squared
summary(r)$coefficients
```

```{r}
sdfurb <- fdf4 %>% filter(area == "rural")
r <- lm(formula = stratio ~` log(prop1), data = fdfurb)
summary(r)
par(mfrow = c(2,2))
plot(r)
library(lmtest)
bptest(r)
```

```{r}
fdfrur <- fdf4 %>% filter(area == "urban")
r1 <- lm(formula = class.size ~ log(prop), data = fdfurb)
summary(r1)
par(mfrow = c(2,2))
plot(r1)
```