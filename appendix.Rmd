---
title: "Appendix"
author: "Max Aantjes"
date: "15/09/2020"
output:
  github_document:
    toc: true
    toc_depth: 2
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction
The following sections contain all computations for the creation of the exploratory data results summarised in the brief paper. Computations are accompanied by references and justifications to clarify any choices made. Through *code book tables*, explicit references are also made to the survey questions which responses were used in the analysis. 

# R Packages
The following R packages are used in the subsequent code sections. 
```{r, message = FALSE}
library(openxlsx)
library(stringr)
library(tidyverse)
library(xts)
library(foreign)
```
 
```{r}
rep_sp_char <- function(x){
        sp_char <- c("á", "é", "í", "ó", "ñ")
        rep <- c("a", "e", "i", "o", "n")
        for(i in 1:length(rep)){
                x <- gsub(sp_char[i], rep[i], x)}
        return(x)}
```

# Downloading the Data
## Year on Year data of start-of-school-year Matriculations 
These data sets are updated every year, so it possible that links stop working. You can download the relevant data sets (tabulados por sostenimiento) from this website: https://educacion.gob.ec/indice-de-tabulados/

```{r echo = TRUE, results = 'hide', message = FALSE}
## Download Data
links <- list("https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=15555", "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=15556", "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=15557", "https://educacion.gob.ec/wp-content/plugins/download-monitor/download.php?id=15558")
dfl <- lapply(links, read.xlsx, sheet = 5, startRow = 12)
addcol <- function(x){
        y <- c("fiscal", "particular", "municipal", "fiscomisional")
        for(i in 1:length(x)){x[[i]]$type <- y[i]}
        return(x)}
dfl1 <- addcol(dfl)
dfl2 <- lapply(dfl1, pivot_longer, cols = "2009-2010.Inicio":"2019-2020.Inicio",
               names_to = "schoolyear", values_to = "no.students")
df <- do.call(rbind, dfl2) %>%
        rename("province" = Provincia)
```

```{r}
sdf <- read.csv("dfzone3.csv") %>%
        mutate(schoolyear = "2020-2021.Inicio") %>%
        pivot_longer(cols = "fiscal":"municipal", names_to = "type",
                     values_to = "no.students")
```

## Population projections by year
https://www.ecuadorencifras.gob.ec/proyecciones-poblacionales/
```{r}
url <- "https://www.ecuadorencifras.gob.ec/documentos/web-inec/Poblacion_y_Demografia/Proyecciones_Poblacionales/PROYECCION_POR_EDADES_PROVINCIAS_2010-2020_Y_NACIONAL_2010-2020.xlsx"
sheets <- 2:12
years <- 2010:2020
read.mult.xlsx <- function(x, y, z){
  q <- list()
  for(i in 1:length(y)){
        q[[i]] <- read.xlsx(x, sheet = y[i], startRow = 8)
        q[[i]]$year = z[i]}
  q <- do.call(rbind, q)
  return(q)}
tdf <- read.mult.xlsx(url, sheets, years)
```

# Data Cleaning
## Year on Year data of start-of-school-year Matriculations

```{r}
## Merge data 
df1 <- rbind(df, sdf)
```

```{r}
## Select data of interest
pvint <- c("chimborazo", "cotopaxi", "pastaza", "tungurahua")
df2 <- df1 %>%
        mutate(province = tolower(rep_sp_char(province))) %>%
        filter(province %in% pvint)
```

```{r}
## Create a time series data frame
df3 <- df2 %>%
        mutate(schoolyear = as.Date(paste0(
                str_extract(schoolyear, "^[0-9]{4}"), 
                "-09-01"), format = "%Y-%m-%d"))
```

## Population projections by year

```{r}
## Clean column names
names(tdf) <- tolower(rep_sp_char(names(tdf)))

## Select data of interest
tdf1 <- tdf %>%
        mutate(age = gsub(" ", "", x1)) %>%
        filter(age %in% c("5-9", "10-14", "15-19")) %>%
        mutate(schoolyear = as.Date(
                paste0(year, "-09-01"), format = "%Y-%m-%d")) %>%
        select(schoolyear, age, "chimborazo" = 'chimbo-razo', cotopaxi, 
               pastaza, "tungurahua" = 'tungu-rahua') %>%
        group_by(schoolyear) %>%
        summarise_at(vars(chimborazo:tungurahua), sum) %>%
        pivot_longer(cols = chimborazo:tungurahua, 
                     values_to = "est.schoolgoing.pop", 
                     names_to = "province")
```


```{r}
df1 <- df %>%
        select("sum.students" = 'total.estudiantes.(inicial.a.3ro..de.bachillerato)', 
               "sum.teachers" ="total.docentes", 
               "school.name" = nombre.institucion, 
               "area" = zona.inec, "finance.type" = sostenimiento, canton, 
               "province" = provincia, "zone" = zona, 
               "education.level" = nivel.educacion,
               "region" = regimen.escolar, modallidad) %>%
        mutate(finance.type = factor(tolower(finance.type))) %>%
        mutate(area = factor(str_remove(area, "INEC"))) %>%
        mutate(canton = factor(tolower(rep_sp_char(canton)))) %>%
        mutate(province = factor(tolower(rep_sp_char(province))))

sdf1 <- sdf %>%
        pivot_longer(cols = c(fiscal, fiscomisional, particular, municipal),
                     values_to = "sum.students", names_to = "finance.type") 
```

```{r}
df2 <- df1 %>%
        group_by(finance.type) %>%
        summarise(sum(sum.students))
sum(df1$sum.students)
```


```{r}
df2 <- df1 %>%
        filter(zone == "ZONA 3") %>%
        filter(finance.type %in% c("fiscal", "particular"))

sdf2 <- sdf1 %>%
        filter(finance.type %in% c("fiscal", "particular"))

## Calculate Statistics
df3 <- df2 %>%
        group_by(province, finance.type) %>%
        summarise(sum.students = sum(sum.students))

## Join the two tables
df4 <- df3 %>%
        full_join(sdf2, by = c("province", "finance.type")) %>%
        rename(y1 = 3, y2 = 4) %>%
        pivot_longer(cols = c(y1, y2), values_to = "sum.students",
                     names_to = "schoolyear")

## Calculate change
df5 <- df4 %>%
        pivot_wider(values_from = sum.students, names_from = schoolyear) %>%
        mutate(change = (y2-y1))

## Plot
p <- ggplot(data = df5, aes(y = change, 
                            x = province, fill = finance.type))
p1 <- p + geom_bar(stat = "identity", position = "dodge")
p2 <- p1 + theme_bw() +
        theme(axis.text.x=element_text(angle = 90, vjust = 0.5))
p3 <- p2 + labs(y = "Change in the number of Students (Absolute)",
                x = "Province",
                title = "Figure 1: The Change in Primary and Secondary\nEducation Enrolment between 2019 and 2020 in Zone 3",
                caption = "Source: Data from INEC (AMIE) and MINEDUC\nData Summary by author (Max Aantjes)")
p4 <- p3 + scale_fill_discrete(name = "School Type", labels = c("Public",
                                          "Private"))
p4


```

